<div class="container mt-4 page-transition">
    <!-- Back Button -->
    <div class="mb-3">
        <button class="btn btn-outline-secondary" routerLink="/job-details/{{job?.id}}">
            <i class="fas fa-arrow-left"></i> Retour aux détails du poste
        </button>
    </div>

    <!-- Loading State -->
    <div class="text-center" *ngIf="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Chargement...</span>
        </div>
        <p class="mt-3">Chargement du formulaire...</p>
    </div>

    <!-- Error State -->
    <div class="alert alert-danger" *ngIf="error && !loading">
        <h4 class="alert-heading">Erreur</h4>
        <p>{{error}}</p>
        <button class="btn btn-primary" (click)="goBack()">Retour aux offres</button>
    </div>

    <!-- Application Form -->
    <div class="application-form-card card" *ngIf="!loading && !error && job">
        <div class="card-header">
            <h3 class="mb-0">
                <i class="fas fa-paper-plane me-2"></i>
                Postuler pour le poste
            </h3>
            <p class="text-muted mb-0 mt-2">Candidature pour: {{job.title}}</p>
        </div>

        <div class="card-body">
            <!-- Job Summary -->
            <div class="job-summary alert alert-light mb-4">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="job-title">{{job.title}}</h5>
                        <p class="company-name text-muted mb-2">{{getCompanyName()}}</p>
                        <div class="job-meta">
                            <span class="badge badge-light me-2">
                                <i class="fas fa-map-marker-alt"></i> 
                                {{job.location || 'Non spécifiée'}}
                            </span>
                            <span class="badge badge-success me-2" *ngIf="job.isRemote">
                                <i class="fas fa-home"></i> Télétravail
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge badge-primary fs-6">{{getJobTypeDisplay()}}</span>
                    </div>
                </div>
            </div>

            <!-- Application Form -->
            <form [formGroup]="applicationForm" (ngSubmit)="onSubmit()" novalidate>
                <div class="row">
                    <!-- Personal Information -->
                    <div class="col-md-6">
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-user me-2"></i>
                                Informations personnelles
                            </h5>
                            
                            <div class="mb-3">
                                <label for="firstName" class="form-label">Prénom *</label>
                                <input type="text" 
                                       class="form-control" 
                                       [class.is-invalid]="isFieldInvalid('firstName')"
                                       id="firstName" 
                                       formControlName="firstName">
                                <div class="invalid-feedback" *ngIf="isFieldInvalid('firstName')">
                                    {{getFieldError('firstName')}}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="lastName" class="form-label">Nom *</label>
                                <input type="text" 
                                       class="form-control" 
                                       [class.is-invalid]="isFieldInvalid('lastName')"
                                       id="lastName" 
                                       formControlName="lastName">
                                <div class="invalid-feedback" *ngIf="isFieldInvalid('lastName')">
                                    {{getFieldError('lastName')}}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" 
                                       class="form-control" 
                                       [class.is-invalid]="isFieldInvalid('email')"
                                       id="email" 
                                       formControlName="email">
                                <div class="invalid-feedback" *ngIf="isFieldInvalid('email')">
                                    {{getFieldError('email')}}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="phone" class="form-label">Téléphone *</label>
                                <input type="tel" 
                                       class="form-control" 
                                       [class.is-invalid]="isFieldInvalid('phone')"
                                       id="phone" 
                                       formControlName="phone">
                                <div class="invalid-feedback" *ngIf="isFieldInvalid('phone')">
                                    {{getFieldError('phone')}}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Application Details -->
                    <div class="col-md-6">
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-briefcase me-2"></i>
                                Détails de candidature
                            </h5>
                            <div class="mb-3">
                                <label for="resume" class="form-label">CV *</label>
                                <div class="custom-file-upload">
                                    <input type="file" 
                                        class="form-control" 
                                        [class.is-invalid]="isFieldInvalid('resume')"
                                        id="resume" 
                                        (change)="onFileSelected($event)"
                                        accept=".pdf,.doc,.docx">
                                    <div class="file-upload-text" *ngIf="!isFileSelected()">
                                        <i class="fas fa-upload me-2"></i>
                                        Choisir un fichier
                                    </div>
                                    <div class="file-selected-text" *ngIf="isFileSelected()">
                                        <i class="fas fa-file-pdf me-2"></i>
                                        {{getFileUploadText()}}
                                    </div>
                                </div>
                                <div class="form-text">
                                    Formats acceptés: PDF, DOC, DOCX (Max: 5MB)
                                </div>
                                <div class="invalid-feedback" *ngIf="isFieldInvalid('resume')">
                                    {{getFieldError('resume')}}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="portfolioUrl" class="form-label">Portfolio/LinkedIn (optionnel)</label>
                                <input type="url" 
                                       class="form-control" 
                                       [class.is-invalid]="isFieldInvalid('portfolioUrl')"
                                       id="portfolioUrl" 
                                       formControlName="portfolioUrl"
                                       placeholder="https://...">
                                <div class="invalid-feedback" *ngIf="isFieldInvalid('portfolioUrl')">
                                    {{getFieldError('portfolioUrl')}}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="expectedSalary" class="form-label">Salaire souhaité (optionnel)</label>
                                <div class="input-group">
                                    <input type="number" 
                                           class="form-control" 
                                           [class.is-invalid]="isFieldInvalid('expectedSalary')"
                                           id="expectedSalary" 
                                           formControlName="expectedSalary"
                                           placeholder="Ex: 2000">
                                    <span class="input-group-text">TND</span>
                                </div>
                                <div class="invalid-feedback" *ngIf="isFieldInvalid('expectedSalary')">
                                    {{getFieldError('expectedSalary')}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cover Letter -->
                <div class="form-section mt-4">
                    <h5 class="section-title">
                        <i class="fas fa-edit me-2"></i>
                        Lettre de motivation *
                    </h5>
                    <div class="mb-3">
                        <textarea class="form-control" 
                                  [class.is-invalid]="isFieldInvalid('coverLetter')"
                                  id="coverLetter" 
                                  formControlName="coverLetter"
                                  rows="8" 
                                  placeholder="Expliquez pourquoi vous êtes le candidat idéal pour ce poste..."></textarea>
                        <div class="form-text">
                            <span [class]="getCoverLetterCountClass()">{{getCoverLetterCount()}}</span>/{{coverLetterMaxLength}} caractères
                        </div>
                        <div class="invalid-feedback" *ngIf="isFieldInvalid('coverLetter')">
                            {{getFieldError('coverLetter')}}
                        </div>
                    </div>
                </div>


                <!-- Submit Buttons -->
                <div class="form-actions mt-4 pt-3 border-top">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" (click)="goBack()">
                            <i class="fas fa-arrow-left me-2"></i>
                            Annuler
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" (click)="saveDraft()">
                                <i class="fas fa-save me-2"></i>
                                Sauvegarder brouillon
                            </button>
                            <button type="submit" 
                    class="btn btn-primary me-2">
                <i class="fas fa-spinner fa-spin me-2" *ngIf="submitting"></i>
                <i class="fas fa-paper-plane me-2" *ngIf="!submitting"></i>
                {{submitting ? 'Envoi en cours...' : 'Via Form Submit'}}
            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>